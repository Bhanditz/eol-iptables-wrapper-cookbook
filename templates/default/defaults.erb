# Allow established connections for both public and private connections
-A INPUT -i eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -i eth1 -m state --state RELATED,ESTABLISHED -j ACCEPT

# Opening specific whitelisted services:
<% unless @node[:iptables][:whitelist].nil? %>
  <% @node[:iptables][:whitelist].keys.each do |port| %>
    <%# Allow comments: %>
    <% next if port == "_comment" %>
    <% @node[:iptables][:whitelist][port].each do |address| %>
      -A FWR -p tcp -s <%= address %> --dport <%= port %> -j ACCEPT
    <% end %>
  <% end %>
<% end %>

# SSH is an exception; if we didn't specify a whitelist, allow all:
<% if @node[:iptables][:whitelist].nil? or
  @node[:iptables][:whitelist]["22"].nil? %>
  -A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
<% end %>

# THis is a test.

# Opening ports wide open (likely to be overridden above)
<% unless @node[:iptables][:open].nil? %>
  <% @node[:iptables][:open].each do |port| %>
    -A INPUT -p tcp -m tcp --dport <%= port %> -j ACCEPT
  <% end %>
<% end %>
